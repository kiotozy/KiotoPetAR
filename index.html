<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Kioto AR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #ui {
      position: fixed;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 9999;
      pointer-events: auto;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background-color: #00aaff;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- UI BotÃµes -->
  <div id="ui">
    <button id="micButton">ðŸŽ¤ Falar</button>
    <button id="arButton">Ativar AR</button>
  </div>

  <!-- Cena 3D + AR -->
  <a-scene
    embedded
    renderer="colorManagement: true;" 
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    device-orientation-permission-ui="enabled: true"
  >
    <!-- Luz -->
    <a-entity light="type: ambient; intensity: 1.2"></a-entity>
    <a-entity light="type: directional; intensity: 1" position="1 1 0.5"></a-entity>

    <!-- CÃ¢mera -->
    <a-entity camera look-controls position="0 1.6 3"></a-entity>

    <!-- Modelo com animaÃ§Ã£o (ajuste de posiÃ§Ã£o) -->
    <a-entity
      id="kioto"
      gltf-model="kioto.glb"
      animation-mixer="clip: *; loop: repeat"
      position="0 0 -1"
      scale="0.6 0.6 0.6"
      gesture-handler
    ></a-entity>
  </a-scene>

  <!-- Script para rotaÃ§Ã£o -->
  <script>
    AFRAME.registerComponent("gesture-handler", {
      schema: { enabled: { default: true } },
      init: function () {
        this.handleRotation = this.handleRotation.bind(this);
        this.el.sceneEl.canvas.addEventListener("mousedown", (e) => {
          this.startX = e.screenX;
          this.startRot = this.el.object3D.rotation.y;
          window.addEventListener("mousemove", this.handleRotation);
        });
        window.addEventListener("mouseup", () => {
          window.removeEventListener("mousemove", this.handleRotation);
        });
      },
      handleRotation: function (e) {
        const delta = (e.screenX - this.startX) * 0.01;
        this.el.object3D.rotation.y = this.startRot - delta;
      },
    });
  </script>

  <!-- Reconhecimento de voz -->
  <script>
    const comandos = {
      "olÃ¡": "ola.mp3",
      "bom dia": "bom_dia.mp3",
      "boa tarde": "boa_tarde.mp3",
      "boa noite": "boa_noite.mp3",
      "qual seu nome": "qual_seu_nome.mp3",
      "quer ser meu amigo": "quer_ser_meu_amigo.mp3",
      "comandos": "comandos.mp3",
      "danÃ§ar": "danÃ§ar",
      "parar": "parar"
    };

    const micButton = document.getElementById("micButton");
    let recognition;

    micButton.addEventListener("click", () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Reconhecimento de voz nÃ£o suportado no seu navegador.");
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = (event) => {
        const comando = event.results[0][0].transcript.toLowerCase();
        console.log("Comando detectado:", comando);
        processarComando(comando);
      };

      recognition.onerror = (event) => {
        console.error("Erro no reconhecimento:", event.error);
      };

      recognition.start();
    });

    function processarComando(comando) {
      const audio = new Audio();
      const entity = document.querySelector("#kioto");

      if (comando === "danÃ§ar") {
        entity.setAttribute("animation-mixer", "clip: *; loop: repeat");
      } else if (comando === "parar") {
        entity.removeAttribute("animation-mixer");
      } else if (comandos[comando]) {
        audio.src = comandos[comando];
        audio.play();
      } else {
        const fallback = new Audio("nao_entendi.mp3");
        fallback.play();
      }
    }
  </script>

  <!-- ForÃ§ar visibilidade dos botÃµes no AR -->
  <script>
    const arButton = document.getElementById("arButton");
    arButton.addEventListener("click", () => {
      document.querySelector("a-scene").enterAR();
      setTimeout(() => {
        document.getElementById("ui").style.display = "flex";
      }, 2000);
    });
  </script>
</body>
</html>
