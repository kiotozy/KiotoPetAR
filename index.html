<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Personagem 3D + AR com Gestos</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="antialias: true; colorManagement: true;"
    >
      <!-- Luz -->
      <a-entity light="type: directional; intensity: 1" position="1 1 1"></a-entity>
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>

      <!-- Modelo 3D -->
      <a-entity
        id="personagem"
        gltf-model="url(https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Fox/glTF/Fox.gltf)"
        position="0 0 -2"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
      ></a-entity>

      <!-- Câmera -->
      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const personagem = document.getElementById("personagem");
      const scene = document.querySelector("a-scene");

      let startDistance = 0;
      let startScale = 1;
      let lastX = 0,
        lastY = 0;
      let isTwoFingers = false;

      function getDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      scene.addEventListener("loaded", () => {
        const canvas = scene.renderer.domElement;

        canvas.addEventListener("touchstart", (e) => {
          if (e.touches.length === 2) {
            isTwoFingers = true;
            startDistance = getDistance(e.touches);
            const s = personagem.getAttribute("scale");
            startScale = s.x;
            lastX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            lastY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
          } else if (e.touches.length === 1) {
            isTwoFingers = false;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
          }
        });

        canvas.addEventListener("touchmove", (e) => {
          if (e.touches.length === 2) {
            // Pinça (escala)
            const newDist = getDistance(e.touches);
            const scaleFactor = newDist / startDistance;
            const newScale = startScale * scaleFactor;
            personagem.setAttribute("scale", {
              x: newScale,
              y: newScale,
              z: newScale,
            });

            // Movimento no plano
            const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const dx = (midX - lastX) * 0.01;
            const dy = (midY - lastY) * 0.01;
            const pos = personagem.getAttribute("position");
            personagem.setAttribute("position", {
              x: pos.x + dx,
              y: pos.y - dy,
              z: pos.z,
            });
            lastX = midX;
            lastY = midY;
          } else if (e.touches.length === 1) {
            // Rotação
            const dx = e.touches[0].clientX - lastX;
            const rot = personagem.getAttribute("rotation");
            personagem.setAttribute("rotation", {
              x: rot.x,
              y: rot.y + dx * 0.5,
              z: rot.z,
            });
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
          }
        });
      });
    </script>
  </body>
</html>
