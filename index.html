<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kioto - Seu Pet de RA</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        .mic-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        .mic-button:hover {
            background-color: #d32f2f;
        }
        .mic-button.listening {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <a-scene
        embedded
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
        vr-mode-ui="enabled: false">

        <a-assets>
            <a-asset-item id="kioto-model" src="kioto.glb"></a-asset-item>
        </a-assets>

        <a-marker preset="hiro">
            <a-entity
                gltf-model="#kioto-model"
                scale="0.2 0.2 0.2"
                animation-mixer="clip: action_wave"
                id="kioto-entity">
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <button id="micButton" class="mic-button">ðŸŽ¤ Falar</button>

    <script>
        // LÃ³gica para as animaÃ§Ãµes
        let kiotoModel = document.getElementById('kioto-entity');
        
        function playAnimation(clipName) {
            kiotoModel.setAttribute('animation-mixer', {
                clip: clipName,
                loop: 'once'
            });
            kiotoModel.addEventListener('animation-mixer-finished', () => {
                kiotoModel.setAttribute('animation-mixer', { clip: '' });
            }, { once: true });
        }

        // VariÃ¡veis de controle para o Ã¡udio
        let currentAudio = null;
        let isSpeaking = false;

        // ConfiguraÃ§Ã£o do reconhecimento de voz
        const micButton = document.getElementById('micButton');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;

            micButton.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    if (isSpeaking) {
                        if (currentAudio) {
                            currentAudio.pause();
                            currentAudio.currentTime = 0;
                            isSpeaking = false;
                        }
                    }
                    recognition.start();
                }
            });

            recognition.onstart = () => {
                isListening = true;
                micButton.classList.add("listening");
                micButton.textContent = "ðŸŽ¤ Ouvindo...";
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove("listening");
                micButton.textContent = "ðŸŽ¤ Falar";
            };

            // LÃ³gica principal que decide entre animaÃ§Ã£o e IA
            recognition.onresult = async (event) => {
                const comando = event.results[0][0].transcript.toLowerCase();
                console.log("Comando de voz:", comando);
                
                // VERIFICA COMANDOS DE ANIMAÃ‡ÃƒO PRIMEIRO
                if (comando.includes("danÃ§a")) {
                    playAnimation("action_dance");
                    speakText("Eu adoro danÃ§ar!");
                    return; // Interrompe a execuÃ§Ã£o para nÃ£o ir para a IA
                }
                
                if (comando.includes("senta")) {
                    playAnimation("action_sit");
                    speakText("Ok, vou sentar!");
                    return; // Interrompe a execuÃ§Ã£o para nÃ£o ir para a IA
                }

                // Se nÃ£o for um comando de animaÃ§Ã£o, envia para a IA
                try {
                    const response = await fetch('/.netlify/functions/pergunte-kioto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ userText: comando }),
                    });

                    if (!response.ok) {
                        throw new Error(`Erro: ${response.status}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    playAudioFromURL(audioUrl);

                } catch (error) {
                    console.error("Erro ao se comunicar com a IA:", error);
                    speakText("Desculpe, houve um erro ao tentar me comunicar com a inteligÃªncia artificial.");
                }
            };

            // FunÃ§Ã£o para tocar o Ã¡udio da URL gerada
            function playAudioFromURL(url) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                const audio = new Audio(url);
                isSpeaking = true;
                currentAudio = audio;
                audio.play();
                audio.onended = () => {
                    isSpeaking = false;
                    currentAudio = null;
                    URL.revokeObjectURL(url);
                };
            }

            // FunÃ§Ã£o de fallback para a API de SÃ­ntese de Voz do navegador
            const synth = window.speechSynthesis;
            function speakText(text) {
                if (synth.speaking) {
                    synth.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = synth.getVoices();
                const portugueseVoice = voices.find(voice => voice.lang === 'pt-BR');
                if (portugueseVoice) {
                    utterance.voice = portugueseVoice;
                }
                synth.speak(utterance);
            }

        } else {
            alert("Seu navegador nÃ£o suporta reconhecimento de voz.");
        }
    </script>
</body>
</html>
