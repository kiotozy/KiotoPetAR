<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/loaders/GLTFLoader.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer;
let controller;
let model;
let mixer, action;
let clock = new THREE.Clock();
let isAnimating = true;

init();
animate();

function init() {
  const container = document.createElement('div');
  document.body.appendChild(container);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  container.appendChild(renderer.domElement);

  document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

  controller = renderer.xr.getController(0);
  scene.add(controller);

  controller.addEventListener('select', onSelect);

  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  light.position.set(0.5, 1, 0.25);
  scene.add(light);

  setupUI();

  renderer.xr.addEventListener('sessionstart', () => {
    loadModel(); // SÃ³ carrega modelo depois do AR iniciar
  });
}

function onSelect() {
  if (!model) return;

  model.visible = true;
  model.position.set(0, 0, -0.5).applyMatrix4(controller.matrixWorld);
  model.quaternion.setFromRotationMatrix(controller.matrixWorld);
}

function loadModel() {
  const loader = new GLTFLoader();
  loader.load('modelos/kioto.glb', (gltf) => {
    model = gltf.scene;
    model.scale.set(0.5, 0.5, 0.5);
    model.visible = true;
    scene.add(model);

    mixer = new THREE.AnimationMixer(model);
    action = mixer.clipAction(gltf.animations[0]);
    action.play();
  });
}

function animate() {
  renderer.setAnimationLoop(render);
}

function render() {
  const delta = clock.getDelta();
  if (mixer && isAnimating) mixer.update(delta);
  renderer.render(scene, camera);
}

function setupUI() {
  const pauseBtn = document.createElement('button');
  pauseBtn.textContent = 'Pausar AnimaÃ§Ã£o';
  pauseBtn.style.position = 'fixed';
  pauseBtn.style.bottom = '20px';
  pauseBtn.style.left = '10px';
  document.body.appendChild(pauseBtn);

  pauseBtn.addEventListener('click', () => {
    isAnimating = !isAnimating;
    pauseBtn.textContent = isAnimating ? 'Pausar AnimaÃ§Ã£o' : 'Reiniciar AnimaÃ§Ã£o';
  });

  const micBtn = document.createElement('button');
  micBtn.textContent = 'ðŸŽ¤ Microfone';
  micBtn.style.position = 'fixed';
  micBtn.style.bottom = '20px';
  micBtn.style.left = '150px';
  document.body.appendChild(micBtn);

  micBtn.addEventListener('click', () => {
    startRecognition();
  });
}

function startRecognition() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'pt-BR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.toLowerCase();
    if (transcript.includes('olÃ¡') || transcript.includes('ola')) {
      speak("OlÃ¡, sou o Kioto Pet");
    }
  };

  recognition.onerror = (event) => {
    console.error('Erro de reconhecimento:', event.error);
  };
}

function speak(text) {
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'pt-BR';
  synth.speak(utter);
}
</script>
