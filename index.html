<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Kioto Pet AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@3.3.0/dist/aframe-gesture-detector.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    a-scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #camera-feed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
      display: none;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA4p0lhme7RQf1pN0idXgnbUAdR7z_4m2A",
      authDomain: "kiotopet.firebaseapp.com",
      projectId: "kiotopet",
      storageBucket: "kiotopet.firebasestorage.app",
      messagingSenderId: "200099219198",
      appId: "1:200099219198:web:38d37babfa5fc616fd07af",
      measurementId: "G-W493XKCZFQ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      }
    });
  </script>
</head>
<body>
  <video id="camera-feed" autoplay></video>

  <a-scene id="scene" embedded
    renderer="antialias: true" gesture-detector>

    <a-assets>
      <a-asset-item id="model" src="kioto.glb"></a-asset-item>
      <audio id="bom_dia" src="bom_dia.mp3" preload="auto"></audio>
      <audio id="boa_tarde" src="boa_tarde.mp3" preload="auto"></audio>
      <audio id="boa_noite" src="boa_noite.mp3" preload="auto"></audio>
      <audio id="qual_seu_nome" src="qual_seu_nome.mp3" preload="auto"></audio>
      <audio id="nao_entendi" src="nao_entendi.mp3" preload="auto"></audio>
      <audio id="ola" src="ola.mp3" preload="auto"></audio>
      <audio id="comandos" src="comandos.mp3" preload="auto"></audio>
      <audio id="danca" src="danca.mp3" preload="auto"></audio>
      <audio id="quer_ser_meu_amigo" src="quer_ser_meu_amigo.mp3" preload="auto"></audio>
      <audio id="me_conte_uma_historia" src="me_conte_uma_historia.mp3" preload="auto"></audio>
    </a-assets>

    <a-entity
      id="glb"
      gltf-model="#model"
      animation-mixer
      rotation="0 0 0"
      position="0 0 -2"
      scale="1 1 1"
      gesture-detector
    ></a-entity>

    <a-plane id="ground" position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
    <a-sky id="sky" color="#ECECEC"></a-sky>
    
    <a-entity id="camera" camera position="0 1.6 0" look-controls="enabled: true">
      
      <a-entity id="ui-buttons" position="0 -0.5 -1">
        
        <a-entity id="micButton"
                  position="0 0.2 0"
                  geometry="primitive: plane; width: 0.4; height: 0.15"
                  material="color: #03a9f4"
                  event-set__hover="material.color: #007bb6"
                  event-set__leave="material.color: #03a9f4">
          <a-text value="ðŸŽ¤ Falar" align="center" position="0 0 0.01" color="white" width="1"></a-text>
        </a-entity>

        <a-entity id="arButton"
                  position="0 0 0"
                  geometry="primitive: plane; width: 0.4; height: 0.15"
                  material="color: #03a9f4"
                  event-set__hover="material.color: #007bb6"
                  event-set__leave="material.color: #03a9f4">
          <a-text value="Ativar AR" align="center" position="0 0 0.01" color="white" width="1"></a-text>
        </a-entity>

        <a-entity id="logoutButton"
                  position="0 -0.2 0"
                  geometry="primitive: plane; width: 0.4; height: 0.15"
                  material="color: #f44336"
                  event-set__hover="material.color: #d32f2f"
                  event-set__leave="material.color: #f44336">
          <a-text value="Sair" align="center" position="0 0 0.01" color="white" width="1"></a-text>
        </a-entity>

      </a-entity>
      
    </a-entity>

  </a-scene>

  <script>
    const modelEntity = document.getElementById('glb');
    const scene = document.querySelector('a-scene');
    const ground = document.getElementById('ground');
    const sky = document.getElementById('sky');

    const uiButtons = document.getElementById('ui-buttons');
    const micButton = document.getElementById('micButton');
    const arButton = document.getElementById('arButton');
    const logoutButton = document.getElementById('logoutButton');

    const cameraFeed = document.getElementById('camera-feed');
    let arModeActive = false;

    function toggleArMode() {
      if (!arModeActive) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(stream => {
            cameraFeed.srcObject = stream;
            cameraFeed.style.display = 'block';
            ground.setAttribute('visible', 'false');
            sky.setAttribute('visible', 'false');
            arButton.querySelector('a-text').setAttribute('value', 'Desativar AR');
            arModeActive = true;
          })
          .catch(err => {
            console.error('Erro ao acessar a cÃ¢mera: ', err);
            alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera. Verifique as permissÃµes.');
          });
      } else {
        const stream = cameraFeed.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        cameraFeed.srcObject = null;
        cameraFeed.style.display = 'none';
        ground.setAttribute('visible', 'true');
        sky.setAttribute('visible', 'true');
        arButton.querySelector('a-text').setAttribute('value', 'Ativar AR');
        arModeActive = false;
      }
    }

    logoutButton.addEventListener('click', () => {
        auth.signOut().then(() => {
            window.location.href = "login.html";
        }).catch((error) => {
            console.error("Erro ao fazer logout:", error);
        });
    });

    micButton.addEventListener('click', () => {
        if (isListening) {
            recognition.stop();
        } else if (isSpeaking) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isSpeaking = false;
                currentAudio = null;
            }
            recognition.start();
        } else {
            recognition.start();
        }
    });

    arButton.addEventListener('click', () => {
      toggleArMode();
    });

    window.onload = function() {
        modelEntity.setAttribute('animation-mixer', '');
    };

    AFRAME.registerComponent('gesture-detector', {
      init: function () {
        this.el.sceneEl.addEventListener('onefingermove', (event) => {
          const rotation = this.el.getAttribute('rotation');
          this.el.setAttribute('rotation', {
            x: rotation.x,
            y: rotation.y + event.detail.positionChange.x * 2,
            z: rotation.z
          });
        });
      }
    });

    let recognition;
    let isListening = false;
    let isSpeaking = false;
    let currentAudio = null;

    function playAudio(audioElementId) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      const audio = document.getElementById(audioElementId);
      if (audio) {
        isSpeaking = true;
        currentAudio = audio;
        audio.play();
        audio.onended = () => {
          isSpeaking = false;
          currentAudio = null;
        };
      }
    }

    function speakCommand(comando) {
      comando = comando.toLowerCase();

      if (comando.includes('danÃ§ar')) {
        modelEntity.setAttribute('animation-mixer', '');
        playAudio('danca');
        return;
      }
      
      if (comando.includes('parar')) {
        modelEntity.removeAttribute('animation-mixer');
        return;
      }

      if (comando.includes('bom dia')) {
        playAudio('bom_dia');
      } else if (comando.includes('boa tarde')) {
        playAudio('boa_tarde');
      } else if (comando.includes('boa noite')) {
        playAudio('boa_noite');
      } else if (comando.includes('comandos')) {
        playAudio('comandos');
      } else if (comando.includes('qual seu nome') || comando.includes('seu nome')) {
        playAudio('qual_seu_nome');
      } else if (comando.includes('olÃ¡')) {
        playAudio('ola');
      } else if (comando.includes('quer ser meu amigo')) {
        playAudio('quer_ser_meu_amigo');
      } else if (comando.includes('mÃºsica')) {
        playAudio('danca');
      } else if (comando.includes('me conte uma histÃ³ria')) {
        playAudio('me_conte_uma_historia');
      } else {
        playAudio('nao_entendi');
      }
    }

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = false;
      recognition.interimResults = false;

      micButton.addEventListener('click', () => {
        if (isListening) {
          recognition.stop();
        } else if (isSpeaking) {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            isSpeaking = false;
            currentAudio = null;
          }
          recognition.start();
        } else {
          recognition.start();
        }
      });

      recognition.onstart = () => {
        isListening = true;
        micButton.querySelector('a-text').setAttribute('value', 'ðŸŽ¤ Ouvindo...');
      };

      recognition.onend = () => {
        isListening = false;
        micButton.querySelector('a-text').setAttribute('value', 'ðŸŽ¤ Falar');
      };

      recognition.onresult = (event) => {
        const comando = event.results[0][0].transcript.toLowerCase();
        console.log('Comando de voz:', comando);
        speakCommand(comando);
      };

      recognition.onerror = (event) => {
        console.error('Erro no reconhecimento de voz:', event.error);
        if (event.error !== 'no-speech') {
            micButton.querySelector('a-text').setAttribute('value', 'ðŸŽ¤ Erro');
        }
      };
    }
  </script>
</body>
</html>
