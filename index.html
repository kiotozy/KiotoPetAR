<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Kioto Pet AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- A-Frame e plugins -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@3.3.0/dist/aframe-gesture-detector.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        #buttons {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #micButton {
            background-color: #03a9f4;
        }
        #micButton.listening {
            background-color: green;
        }
        #arButton {
            background-color: #03a9f4;
        }
        #logoutButton {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #f44336;
            z-index: 1001;
        }
        .a-enter-vr-button {
            display: none !important;
        }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA4p0lhme7RQf1pN0idXgnbUAdR7z_4m2A",
            authDomain: "kiotopet.firebaseapp.com",
            projectId: "kiotopet",
            storageBucket: "kiotopet.firebasestorage.app",
            messagingSenderId: "200099219198",
            appId: "1:200099219198:web:38d37babfa5fc616fd07af",
            measurementId: "G-W493XKCZFQ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = "login.html";
        });
    </script>
</head>
<body>
    <div id="buttons">
        <button id="micButton">ðŸŽ¤ Falar</button>
        <button id="arButton">Ativar AR</button>
    </div>
    <button id="logoutButton">Sair</button>

    <a-scene id="scene" embedded xr-mode-ui="enabled: false" vr-mode-ui="enabled: false" renderer="antialias: true" gesture-detector>
        <a-assets>
            <a-asset-item id="model" src="kioto.glb"></a-asset-item>
        </a-assets>

        <a-entity
            id="glb"
            gltf-model="#model"
            position="0 0 -2"
            scale="0.5 0.5 0.5"
            rotation="0 0 0"
            animation-mixer="clip: capoeira"
            gesture-handler>
        </a-entity>

        <a-plane id="ground" position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
        <a-sky id="sky" color="#ECECEC"></a-sky>
        <a-entity camera position="0 1.6 0" look-controls="enabled: true"></a-entity>
    </a-scene>

    <script>
        const modelEntity = document.getElementById('glb');
        const arButton = document.getElementById('arButton');
        const micButton = document.getElementById('micButton');
        const logoutButton = document.getElementById('logoutButton');
        const scene = document.querySelector('a-scene');
        const ground = document.getElementById('ground');
        const sky = document.getElementById('sky');

        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => window.location.href = "login.html");
        });

        arButton.addEventListener('click', () => {
            if (scene.enterAR) {
                scene.enterAR().catch(() => alert("Seu dispositivo nÃ£o suporta AR ou permissÃ£o nÃ£o foi concedida."));
            }
        });

        scene.addEventListener('enter-vr', function () {
            if (this.is('ar-mode')) {
                ground.setAttribute('visible', 'false');
                sky.setAttribute('visible', 'false');
            }
        });

        // Gestos: mover, redimensionar e rotacionar
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                rotationFactor: {default: 5},
                scaleFactor: {default: 2}
            },
            init: function () {
                this.handleRotation = this.handleRotation.bind(this);
                this.handleScale = this.handleScale.bind(this);
                this.handleMove = this.handleMove.bind(this);

                this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
                this.el.sceneEl.addEventListener('twofingermove', this.handleMove);
                this.el.sceneEl.addEventListener('pinchmoved', this.handleScale);
            },
            handleRotation: function (event) {
                const rotation = this.el.getAttribute('rotation');
                rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                this.el.setAttribute('rotation', rotation);
            },
            handleScale: function (event) {
                const scale = this.el.getAttribute('scale');
                const factor = event.detail.scaleChange * this.data.scaleFactor;
                scale.x *= factor;
                scale.y *= factor;
                scale.z *= factor;
                this.el.setAttribute('scale', scale);
            },
            handleMove: function (event) {
                const position = this.el.getAttribute('position');
                position.x += event.detail.positionChange.x;
                position.z += event.detail.positionChange.y;
                this.el.setAttribute('position', position);
            }
        });

        // Ãudio e animaÃ§Ãµes
        let isSpeaking = false;
        let currentAnimation = null;

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                isSpeaking = true;
                utterance.onend = () => { isSpeaking = false; };
                window.speechSynthesis.speak(utterance);
            }
        }

        function setAnimation(clipName) {
            if (currentAnimation === clipName) return;
            modelEntity.setAttribute('animation-mixer', `clip: ${clipName}`);
            currentAnimation = clipName;
        }

        async function processCommand(comando) {
            comando = comando.toLowerCase();

            if (comando.includes("parar")) {
                modelEntity.removeAttribute("animation-mixer");
                currentAnimation = null;
                return;
            }
            if (comando.includes("danÃ§ar") || comando.includes("luta")) {
                setAnimation("capoeira");
                return;
            }
            if (comando.includes("chute")) {
                setAnimation("chute");
                return;
            }
            try {
                const response = await fetch('/.netlify/functions/ask-kioto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userText: comando }),
                });
                const data = await response.json();
                speakText(data.aiResponse);
            } catch {
                speakText("Desculpe, nÃ£o consigo me conectar com a inteligÃªncia artificial agora.");
            }
        }

        // Reconhecimento de voz
        let recognition;
        let isListening = false;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;

            micButton.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    if (isSpeaking) {
                        if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                            window.speechSynthesis.cancel();
                            isSpeaking = false;
                        }
                    }
                    recognition.start();
                }
            });

            recognition.onstart = () => {
                isListening = true;
                micButton.classList.add("listening");
                micButton.textContent = "ðŸŽ¤ Ouvindo...";
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove("listening");
                micButton.textContent = "ðŸŽ¤ Falar";
            };

            recognition.onresult = (event) => {
                const comando = event.results[0][0].transcript;
                processCommand(comando);
            };

            recognition.onerror = () => {
                micButton.classList.remove("listening");
                micButton.textContent = "ðŸŽ¤ Erro";
            };
        } else {
            alert("Seu navegador nÃ£o suporta reconhecimento de voz.");
        }
    </script>
</body>
</html>
